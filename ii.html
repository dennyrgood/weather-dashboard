<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            /* Added -webkit prefix for older iOS compatibility */
            -webkit-box-sizing: border-box; 
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -ms-flex-direction: column;
            flex-direction: column;
            -webkit-box-pack: start;
            -ms-flex-pack: start;
            justify-content: flex-start;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            padding: 8px;
            overflow: hidden;
        }
        
        /* Theme styles */
        body.theme-amber {
            background: -webkit-linear-gradient(315deg, #fef3c7 0%, #fde68a 100%);
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #1c1917;
        }
        
        body.theme-blue {
            background: -webkit-linear-gradient(315deg, #dbeafe 0%, #bfdbfe 100%);
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e3a8a;
        }
        
        body.theme-gray {
            background: -webkit-linear-gradient(315deg, #f3f4f6 0%, #e5e7eb 100%);
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #111827;
        }
        
        body.theme-cream {
            background: -webkit-linear-gradient(315deg, #fef9c3 0%, #fff7d0 100%);
            background: linear-gradient(135deg, #fef9c3 0%, #fff7d0 100%);
            color: #44403c;
        }
        
        /* --- Global Layout --- */
        .container {
            max-width: 100%;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            -webkit-box-pack: center;
            -ms-flex-pack: center;
            justify-content: center;
            gap: 16px;
            padding-bottom: 70px; /* Space for the fixed footer */
        }
        
        @media (min-width: 768px) {
            .container {
                padding-top: 10px;
            }
        }
        
        /* --- Card Styling --- */
        .weather-card {
            background-color: rgba(255, 255, 255, 0.9);
            -webkit-box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 15px;
            border-radius: 16px;
            width: 100%;
            min-height: 220px;
        }

        @media (min-width: 768px) {
            .weather-card {
                width: calc(50% - 8px); 
            }
        }
        
        .card-title {
            font-size: 1.25em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .card-header {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: justify;
            -ms-flex-pack: justify;
            justify-content: space-between;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            margin-bottom: 8px;
        }

        .location {
            font-size: 1.25em;
            font-weight: bold;
        }

        .last-update {
            font-size: 0.8em;
            opacity: 0.7;
        }

        /* --- Main Weather Content Layout --- */
        .main-content {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: horizontal;
            -webkit-box-direction: normal;
            -ms-flex-direction: row;
            flex-direction: row;
            margin-bottom: 15px;
        }

        .main-left, .main-right {
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
        }

        .current-temp {
            font-size: 4em;
            font-weight: 300;
            line-height: 1;
        }

        .temp-unit-small {
            font-size: 0.35em; 
            vertical-align: top;
            opacity: 0.8;
            margin-left: -5px;
        }

        .wind-humidity {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* --- Full-Width Details --- */
        .sun-precept-info {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: justify;
            -ms-flex-pack: justify;
            justify-content: space-between;
            width: 100%; 
            padding: 8px 0;
            font-size: 0.9em;
            opacity: 0.9;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }
        
        .sun-precept-info > div {
            text-align: center;
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
        }

        /* --- Daily Forecast --- */
        .daily-forecast {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: justify;
            -ms-flex-pack: justify;
            justify-content: space-between;
            font-size: 0.9em;
        }

        .day-box {
            text-align: center;
            padding: 0 5px;
        }

        .day-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .day-temp {
            opacity: 0.9;
        }
        
        /* --- Footer/Currency Bar --- */
        .footer-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            -webkit-box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding: 8px 15px;
            font-size: 0.8em;
            text-align: center;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: justify;
            -ms-flex-pack: justify;
            justify-content: space-between;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            z-index: 100;
        }
        
        .time-display {
            font-size: 1.1em;
            font-weight: bold;
            opacity: 0.8;
        }

        .currency-card {
            -webkit-box-flex: 1;
            -ms-flex-positive: 1;
            flex-grow: 1;
            margin: 0 10px;
            text-align: left;
            padding: 5px 10px;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        /* --- Debugging Styles --- */
        .debug-url-display {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 2px;
            font-size: 0.5em;
            opacity: 0.1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: left;
            z-index: 10;
        }
    </style>
</head>
<body class="theme-cream">
    <div class="container">
        <!-- Weather Card 1: Amsterdam -->
        <div class="weather-card" id="amsterdam-weather">
            <div class="debug-url-display" id="amsterdam-debug-url">Loading...</div>
            <div class="card-header">
                <div class="location">Amsterdam</div>
                <div class="last-update">Last Updated: <span id="amsterdam-update-time">--</span></div>
            </div>
            <div class="main-content">
                <div class="main-left">
                    <div class="current-temp"><span id="amsterdam-temp">--</span><span class="temp-unit-small">¬∞F</span></div>
                    <div class="wind-humidity">Wind: <span id="amsterdam-wind">--</span> mph | Feels: <span id="amsterdam-apparent">--</span>¬∞F</div>
                </div>
                <div class="main-right">
                    <div id="amsterdam-weather-icon" style="font-size: 4em; text-align: right;">--</div>
                    <div style="font-size: 0.9em; text-align: right; opacity: 0.8;">Humidity: <span id="amsterdam-humidity">--</span>%</div>
                </div>
            </div>
            
            <div class="sun-precept-info">
                <div>Sunrise: <span id="amsterdam-sunrise">--</span></div>
                <div>Precipitation: <span id="amsterdam-precept-prob">--</span>%</div>
                <div>Sunset: <span id="amsterdam-sunset">--</span></div>
            </div>

            <div class="daily-forecast" id="amsterdam-daily-forecast">
                <!-- Daily forecast injected here -->
            </div>
        </div>

        <!-- Weather Card 2: Maspalomas -->
        <div class="weather-card" id="maspalomas-weather">
            <div class="debug-url-display" id="maspalomas-debug-url">Loading...</div>
            <div class="card-header">
                <div class="location">Maspalomas</div>
                <div class="last-update">Last Updated: <span id="maspalomas-update-time">--</span></div>
            </div>
            <div class="main-content">
                <div class="main-left">
                    <div class="current-temp"><span id="maspalomas-temp">--</span><span class="temp-unit-small">¬∞F</span></div>
                    <div class="wind-humidity">Wind: <span id="maspalomas-wind">--</span> mph | Feels: <span id="maspalomas-apparent">--</span>¬∞F</div>
                </div>
                <div class="main-right">
                    <div id="maspalomas-weather-icon" style="font-size: 4em; text-align: right;">--</div>
                    <div style="font-size: 0.9em; text-align: right; opacity: 0.8;">Humidity: <span id="maspalomas-humidity">--</span>%</div>
                </div>
            </div>
            
            <div class="sun-precept-info">
                <div>Sunrise: <span id="maspalomas-sunrise">--</span></div>
                <div>Precipitation: <span id="maspalomas-precept-prob">--</span>%</div>
                <div>Sunset: <span id="maspalomas-sunset">--</span></div>
            </div>

            <div class="daily-forecast" id="maspalomas-daily-forecast">
                <!-- Daily forecast injected here -->
            </div>
        </div>
    </div>
    
    <div class="footer-bar">
        <div class="time-display">
            Current Time: <span id="current-time">--</span>
        </div>
        <div class="currency-card" id="currency-content">
            <!-- Currency status injected here -->
            Loading Currency Data...
        </div>
    </div>

    <script>
        // --- GLOBAL CONFIG & STATE ---
        // PROXY_URL is required to bypass CORS/mixed content issues on older browsers
        var PROXY_URL = 'https://weatherproxy.ldmathes.cc/';

        // Currency Data Sources
        var altRate = null;
        var altDateTime = null;
        var oxrRate = null;
        var oxrDateTime = null;
        var ecbRate = null;
        var ecbDate = null;
        
        // Currency Thresholds (Example: 1.05000 is 'Good Buy', 1.08000 is 'Bad Buy')
        var lowThreshold = 1.05000; 
        var highThreshold = 1.08000; 

        var completionCount = 0; // Tracks when all XHRs have completed (2 weather + 3 currency)
        var updateTimeout = 15000; // 15 seconds for debug URL to be visible

        // --- UTILITY FUNCTIONS ---
        function padZero(num) {
            return num < 10 ? '0' + num : num;
        }
        
        function isInActiveWindow() {
            // Check for visibility state for battery saving on background updates
            return !document.hidden;
        }
        
        // --- WEATHER CODE MAPPING ---
        function getWeatherIcon(code) {
            // Simplified WMO code mapping for basic icons
            if (code < 3) return '‚òÄÔ∏è'; // Clear/mainly clear
            if (code >= 3 && code < 50) return '‚òÅÔ∏è'; // Overcast, fog
            if (code >= 51 && code < 60) return 'üåßÔ∏è'; // Drizzle
            if (code >= 61 && code < 70) return '‚òî'; // Rain
            if (code >= 71 && code < 80) return '‚ùÑÔ∏è'; // Snow fall
            if (code >= 80 && code < 90) return '‚õàÔ∏è'; // Rain showers
            if (code >= 90) return 'üå©Ô∏è'; // Thunderstorm
            return '‚ùì';
        }

        // --- TEMP CONVERSION ---
        function toFahrenheit(celsius) {
            return Math.round((celsius * 9 / 5) + 32);
        }

        // --- DISPLAY FUNCTIONS ---
        function updateTime() {
            var now = new Date();
            var hours = padZero(now.getHours());
            var minutes = padZero(now.getMinutes());
            var seconds = padZero(now.getSeconds());
            document.getElementById('current-time').innerText = hours + ':' + minutes + ':' + seconds;
        }

        function updateCurrencyDisplay() {
            // Priority: OXR > ECB > Alt Rate (if available and valid)
            const displayRate = oxrRate || ecbRate || altRate || '0.00000';
            const rateNum = parseFloat(displayRate);
            
            let leftIcon = '';
            let rightIcon = '';
            // Check against thresholds
            if (rateNum < lowThreshold && rateNum !== 0) { // Check against low threshold (good rate)
                leftIcon = '‚úÖ ';
            } else if (rateNum > highThreshold) { // Check against high threshold (bad rate)
                rightIcon = ' ‚ùå';
            }
            
            // Construct the detailed info line
            let infoLine = '';
            const parts = [];
            // OXR is prioritized as it's typically the most frequent
            if (oxrRate) parts.push(`OXR $${oxrRate} (${oxrDateTime})`); 
            if (ecbRate) parts.push(`ECB $${ecbRate} (${ecbDate})`); // ECB usually just has a date
            if (altRate) parts.push(`Alt $${altRate}${altDateTime ? ' (' + altDateTime + ')' : ''}`);
            infoLine = parts.join(' ‚Ä¢ ');
            
            // Render the final HTML in the currency card
            document.getElementById('currency-content').innerHTML = `
                <div class="card-title">${leftIcon}1 EUR &rarr; USD: $${rateNum.toFixed(5)}${rightIcon}</div>
                <div style="font-size: 0.6em; opacity: 0.7; margin-top: 2px; word-wrap: break-word; white-space: normal;">${infoLine}</div>
            `;
        }

        function displayWeather(elementId, data) {
            var debugUrlDisplay = document.getElementById(elementId + '-debug-url');

            var current = data.current;
            var daily = data.daily;
            var timezone = data.timezone;
            var now = new Date();

            // Hide debug URL immediately if successful
            debugUrlDisplay.style.visibility = 'hidden'; 
            debugUrlDisplay.style.opacity = '0'; 

            // Current Weather
            document.getElementById(elementId + '-update-time').innerText = padZero(now.getHours()) + ':' + padZero(now.getMinutes());
            document.getElementById(elementId + '-temp').innerText = toFahrenheit(current.temperature_2m);
            document.getElementById(elementId + '-wind').innerText = current.wind_speed_10m.toFixed(1);
            document.getElementById(elementId + '-humidity').innerText = current.relative_humidity_2m;
            document.getElementById(elementId + '-apparent').innerText = toFahrenheit(current.apparent_temperature);
            document.getElementById(elementId + '-weather-icon').innerText = getWeatherIcon(current.weather_code);

            // Sun & Precipitation
            var sunriseUTC = new Date(daily.sunrise[0]);
            var sunsetUTC = new Date(daily.sunset[0]);

            // Convert UTC times to local time using the fetched timezone
            var sunriseTime = new Date(sunriseUTC.toLocaleString('en-US', { timeZone: timezone }));
            var sunsetTime = new Date(sunsetUTC.toLocaleString('en-US', { timeZone: timezone }));
            
            document.getElementById(elementId + '-sunrise').innerText = padZero(sunriseTime.getHours()) + ':' + padZero(sunriseTime.getMinutes());
            document.getElementById(elementId + '-sunset').innerText = padZero(sunsetTime.getHours()) + ':' + padZero(sunsetTime.getMinutes());
            document.getElementById(elementId + '-precept-prob').innerText = daily.precipitation_probability_max[0];


            // Daily Forecast
            var forecastHTML = '';
            for (var i = 1; i < daily.time.length; i++) { // Start from index 1 (tomorrow)
                var date = new Date(daily.time[i]);
                var dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                var tempMax = toFahrenheit(daily.temperature_2m_max[i]);
                var tempMin = toFahrenheit(daily.temperature_2m_min[i]);
                var icon = getWeatherIcon(daily.weather_code[i]);

                forecastHTML += '<div class="day-box">';
                forecastHTML += '<div class="day-name">' + dayName + '</div>';
                forecastHTML += '<div class="day-icon" style="font-size: 1.5em;">' + icon + '</div>';
                forecastHTML += '<div class="day-temp">' + tempMax + '¬∞/' + tempMin + '¬∞</div>';
                forecastHTML += '</div>';
            }
            document.getElementById(elementId + '-daily-forecast').innerHTML = forecastHTML;
        }

        function displayError(elementId, message) {
            var debugUrlDisplay = document.getElementById(elementId + '-debug-url');
            
            debugUrlDisplay.innerText = 'ERROR: ' + message + ' | URL: ' + debugUrlDisplay.innerText;
            debugUrlDisplay.style.visibility = 'visible';
            debugUrlDisplay.style.opacity = '0.9';
            
            document.getElementById(elementId + '-temp').innerText = 'Err';
            document.getElementById(elementId + '-weather-icon').innerText = '‚ùå';
            document.getElementById(elementId + '-update-time').innerText = '--:--';
            document.getElementById(elementId + '-daily-forecast').innerHTML = '<div style="padding: 10px;">Failed to load data.</div>';
        }

        // --- DATA FETCHING ---
        function fetchWeatherForLocation(elementId, lat, lon) {
            // A. The original target API URL
            var apiUrl = 'http://api.open-meteo.com/v1/forecast?latitude=' + lat + '&longitude=' + lon + 
                         '&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m' +
                         '&daily=sunrise,sunset,temperature_2m_max,temperature_2m_min,precipitation_probability_max,weather_code' +
                         '&temperature_unit=celsius&wind_speed_unit=mph&timezone=auto&forecast_days=4';
            
            // B. Construct the full PROXY URL
            var url = PROXY_URL + '?url=' + encodeURIComponent(apiUrl);
            
            // Debugging: Display the generated URL temporarily
            var debugUrlDisplay = document.getElementById(elementId + '-debug-url');
            debugUrlDisplay.innerText = url;
            debugUrlDisplay.style.visibility = 'visible';
            debugUrlDisplay.style.opacity = '0.1'; 
            
            // Start a timer to hide the URL if it takes too long to load or fails
            var debugTimeout = setTimeout(function() {
                debugUrlDisplay.style.visibility = 'hidden';
                debugUrlDisplay.style.opacity = '0';
            }, updateTimeout);

            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.timeout = 20000;
            
            xhr.onload = function() {
                clearTimeout(debugTimeout);
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        displayWeather(elementId, data);
                    } catch (e) {
                        displayError(elementId, 'JSON Parse Error');
                    }
                } else {
                    displayError(elementId, 'HTTP Status ' + xhr.status);
                }
                checkComplete();
            };
            
            xhr.onerror = function() {
                clearTimeout(debugTimeout);
                displayError(elementId, 'Network Error');
                checkComplete();
            };
            
            xhr.ontimeout = function() {
                clearTimeout(debugTimeout);
                displayError(elementId, 'Timeout');
                checkComplete();
            };
            
            xhr.send();
        }

        function fetchAllWeather() {
            completionCount = 0;
            // Amsterdam (Example Lat/Lon)
            fetchWeatherForLocation('amsterdam', 52.37, 4.89); 
            // Maspalomas (Example Lat/Lon)
            fetchWeatherForLocation('maspalomas', 27.76, -15.58);
        }

        function checkComplete() {
            completionCount++;
            // We have 2 weather + 3 currency requests. Total 5
            if (completionCount >= 5) { 
                updateCurrencyDisplay();
            }
        }
        
        // Exchangerate-API (Alt Rate)
        function fetchCurrencyAlt() {
            var currencyApiUrl = 'https://api.exchangerate-api.com/v4/latest/EUR'; 
            var proxiedCurrencyUrl = PROXY_URL + '?url=' + encodeURIComponent(currencyApiUrl);
            
            var xhr = new XMLHttpRequest();
            xhr.open('GET', proxiedCurrencyUrl, true);
            xhr.timeout = 20000;
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        altRate = data.rates.USD.toFixed(5);
                        
                        if (data.time_last_update_utc) {
                            var updateDate = new Date(data.time_last_update_utc);
                            if (!isNaN(updateDate.getTime())) {
                                var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                var month = months[updateDate.getMonth()];
                                var day = updateDate.getDate();
                                var hours = padZero(updateDate.getHours());
                                var minutes = padZero(updateDate.getMinutes());
                                altDateTime = month + ' ' + day + ', ' + hours + ':' + minutes;
                            }
                        }
                    } catch (e) {}
                }
                checkComplete();
            };
            xhr.onerror = function() { checkComplete(); };
            xhr.ontimeout = function() { checkComplete(); };
            xhr.send();
        }

        // European Central Bank (ECB) via exchangerate.host
        function fetchCurrencyECB() {
            var ecbApiUrl = 'https://api.exchangerate.host/latest?base=EUR&symbols=USD'; 
            var proxiedEcbUrl = PROXY_URL + '?url=' + encodeURIComponent(ecbApiUrl);
            
            var xhr = new XMLHttpRequest();
            xhr.open('GET', proxiedEcbUrl, true);
            xhr.timeout = 20000;
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        ecbRate = data.rates.USD.toFixed(5);
                        ecbDate = data.date; 
                    } catch (e) {}
                }
                checkComplete();
            };
            xhr.onerror = function() { checkComplete(); };
            xhr.ontimeout = function() { checkComplete(); };
            xhr.send();
        }

        // Open Exchange Rates (OXR)
        function fetchCurrencyOXR() {
            // NOTE: This uses a publicly visible App ID for demonstration/testing purposes
            var oxrApiUrl = 'https://openexchangerates.org/api/latest.json?app_id=d6235b2069a74a129d4d5e9754f76226&base=EUR';
            var proxiedOxrUrl = PROXY_URL + '?url=' + encodeURIComponent(oxrApiUrl);
            
            var xhr = new XMLHttpRequest();
            xhr.open('GET', proxiedOxrUrl, true);
            xhr.timeout = 20000;
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        oxrRate = data.rates.USD.toFixed(5);
                        
                        if (data.timestamp) {
                            var updateDate = new Date(data.timestamp * 1000); // Unix timestamp is in seconds
                            if (!isNaN(updateDate.getTime())) {
                                var hours = padZero(updateDate.getHours());
                                var minutes = padZero(updateDate.getMinutes());
                                oxrDateTime = hours + ':' + minutes;
                            }
                        }
                    } catch (e) {}
                }
                checkComplete();
            };
            xhr.onerror = function() { checkComplete(); };
            xhr.ontimeout = function() { checkComplete(); };
            xhr.send();
        }


        function fetchCurrency() {
            fetchCurrencyAlt();
            fetchCurrencyECB();
            fetchCurrencyOXR();
        }
        
        // --- INITIALIZATION ---
        updateTime();
        setInterval(updateTime, 1000);
        
        fetchAllWeather();
        fetchCurrency();
        
        // Weather updates every 10 minutes (600,000 ms)
        setInterval(fetchAllWeather, 600000); 
        
        // Currency updates every hour (3,600,000 ms), only when the window is active
        setInterval(function() {
            if (isInActiveWindow()) {
                fetchCurrency();
            }
        }, 3600000);
    </script>
</body>
</html>
