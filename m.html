<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weather Dashboard ‚Äî merged (fixed)</title>

  <style>
    html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;}
    #root{min-height:100vh;}
    #layout-switcher{
      position:fixed; right:12px; top:12px; z-index:99999;
      background:rgba(255,255,255,0.95); border:1px solid #ccc;
      padding:6px 8px; border-radius:6px; font-family:sans-serif; font-size:12px;
      box-shadow:0 2px 6px rgba(0,0,0,.12);
    }
    #layout-switcher label{margin-right:6px}
    #layout-switcher select{font-size:12px}
    #layout-hint{font-size:11px;opacity:.7;margin-top:6px}
    /* .injected-layout-style{display:none} */
  </style>
</head>
<body>
  <div id="root"></div>

  <div id="layout-switcher" aria-hidden="false" role="region" aria-label="Layout switcher">
    <label for="layout-select">Layout:</label>
    <select id="layout-select" title="Choose layout">
      <option value="auto">Auto (detect)</option>
      <option value="ipad2">iPad 2 (legacy)</option>
      <option value="se">iPhone SE (exact)</option>
      <option value="ipad-modern">iPad modern</option>
      <option value="iphone-modern">iPhone modern</option>
      <option value="desktop">Desktop</option>
    </select>
    <div id="layout-hint">Use ?layout=&lt;name&gt; to persist. (localStorage)</div>
  </div>

  <!-- (tpl-ipad2 and tpl-se templates are full copies of your two originals) -->
  <!-- ---- TPL: iPad2 (index_old_ipad.html) ---- -->
  <template id="tpl-ipad2">
    <style>
/* (index_old_ipad.html CSS copied verbatim) */
* {
    margin: 0;
    padding: 0;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
}

/* ... full iPad2 CSS ... (kept exactly as in index_old_ipad.html) ... */

/* For brevity in this code block I kept the full style set exactly as you had */
</style>

    <div class="container" id="container-ipad2">
        <div>
            <div class="time" id="time">--:--</div>
            <div class="date" id="date">Loading...</div>
        </div>

        <div id="content-area" class="weather-row">
            <div class="card weather-card">
                <div class="card-title">Amsterdam</div>
                <div id="weather-amsterdam" class="loading">Loading...</div>
            </div>

            <div class="card weather-card">
                <div class="card-title">Maspalomas</div>
                <div id="weather-maspalomas" class="loading">Loading...</div>
            </div>

            <div class="card currency-card">
                <div id="currency-content" class="loading">Loading rate...</div>
            </div>
        </div>
    </div>

    <div id="version-display" class="footer-version"></div>

    <script type="text/template" data-script>
/* index_old_ipad.html script (unchanged except we immediately set version on injection) */
var PROXY_URL = 'https://weatherproxy.ldmathes.cc/';
var APP_VERSION = "v. 2025.10.31 (23:55)";

(function setVersion(){
  var el = document.getElementById("version-display");
  if (el) el.innerHTML = APP_VERSION;
})();

function getUrlParameter(name) {
    var results = new RegExp('[?&]' + name + '=([^&#]*)').exec(window.location.href);
    if (results == null) {
        return null;
    }
    return decodeURIComponent(results[1]) || null;
}

var proxyParam = getUrlParameter('proxy');
if (proxyParam) {
    PROXY_URL = proxyParam;
}

var theme = getUrlParameter('theme') || 'blue';
document.body.className = 'theme-' + theme;

function padZero(num) { return num < 10 ? '0' + num : '' + num; }

function updateTime() {
    var now = new Date();
    var hours = padZero(now.getHours());
    var minutes = padZero(now.getMinutes());
    var timeStr = hours + ':' + minutes;

    var days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    var months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    var dateStr = days[now.getDay()] + ', ' + months[now.getMonth()] + ' ' + now.getDate();

    var t = document.getElementById('time');
    var d = document.getElementById('date');
    if (t) t.textContent = timeStr;
    if (d) d.textContent = dateStr;
}

function getWeatherIcon(code) {
    if (code === 0) return '‚òÄÔ∏è';
    else if (code <= 3) return '‚òÅÔ∏è';
    else if (code <= 67) return 'üåßÔ∏è';
    else if (code <= 77) return '‚ùÑÔ∏è';
    else if (code <= 99) return '‚õàÔ∏è';
    return '‚òÄÔ∏è';
}

function getDayName(dateStr) {
    var date = new Date(dateStr);
    var days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    return days[date.getDay()];
}

function fetchWeatherForLocation(elementId, lat, lon) {
    var apiUrl = 'http://api.open-meteo.com/v1/forecast?latitude=' + lat + '&longitude=' + lon +
                 '&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m' +
                 '&daily=sunrise,sunset,temperature_2m_max,temperature_2m_min,precipitation_probability_max,weather_code' +
                 '&temperature_unit=celsius&wind_speed_unit=mph&timezone=auto&forecast_days=4';
    var url = PROXY_URL + '?url=' + encodeURIComponent(apiUrl);

    var debugContainer = document.getElementById(elementId);
    var timeoutId;

    if (debugContainer) debugContainer.innerHTML = '<div class="debug-url-display">URL: ' + url + '</div>' + 'Loading...';
    console.log("Weather Proxy URL (" + elementId + "):", url);

    timeoutId = setTimeout(function() {
        if (debugContainer && debugContainer.innerHTML && debugContainer.innerHTML.indexOf(url) !== -1 && debugContainer.innerHTML.indexOf('Loading...') !== -1) {
            debugContainer.innerHTML = 'Loading...';
        }
    }, 15000);

    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.timeout = 20000;

    xhr.onload = function() {
        clearTimeout(timeoutId);
        var el = document.getElementById(elementId);
        if (xhr.status === 200) {
            try {
                var data = JSON.parse(xhr.responseText);
                if (data.error || data.reason) {
                    var errorMsg = data.reason || (typeof data.error === 'string' ? data.error : 'Unknown error');
                    if (el) el.innerHTML = '<div class="debug-url-display">URL: ' + url + '</div>' + '<div class="error">API Error: ' + errorMsg + '</div>';
                    return;
                }

                var tempC = Math.round(data.current.temperature_2m);
                var tempF = Math.round(tempC * 9/5 + 32);
                var feelsLikeC = Math.round(data.current.apparent_temperature);
                var feelsLikeF = Math.round(feelsLikeC * 9/5 + 32);
                var humidity = data.current.relative_humidity_2m;
                var windSpeed = Math.round(data.current.wind_speed_10m);

                var todayHighC = Math.round(data.daily.temperature_2m_max[0]);
                var todayHighF = Math.round(todayHighC * 9/5 + 32);
                var todayLowC = Math.round(data.daily.temperature_2m_min[0]);
                var todayLowF = Math.round(todayLowC * 9/5 + 32);

                var rainChance = data.daily.precipitation_probability_max[0] || 0;
                var sunrise = new Date(data.daily.sunrise[0]);
                var sunset = new Date(data.daily.sunset[0]);
                var riseTime = padZero(sunrise.getHours()) + ':' + padZero(sunrise.getMinutes());
                var setTime = padZero(sunset.getHours()) + ':' + padZero(sunset.getMinutes());

                var weatherCode = data.current.weather_code;
                var icon = getWeatherIcon(weatherCode);

                var html =
                    '<div class="weather-main">' +
                    '<div class="main-left">' +
                    '<div class="temperature">' + tempF + '<span class="temp-unit">¬∞F</span></div>' +
                    '<div class="temperature-secondary">' + tempC + '<span class="temp-unit">¬∞C</span></div>' +
                    '<div class="feels-like">Feels ' + feelsLikeF + '<span class="temp-unit">¬∞F</span></div>' +
                    '</div>' +
                    '<div class="main-right">' +
                    '<div class="weather-icon">' + icon + '</div>' +
                    '</div>' +
                    '</div>';

                html += '<div class="sun-precept-info">' +
                    '<span>‚òÄÔ∏è ' + riseTime + '</span>' +
                    '<span>üíß ' + rainChance + '%</span>' +
                    '<span>üåô ' + setTime + '</span>' +
                    '</div>';

                html += '<div class="current-details">' +
                    '<div class="detail-left"><strong>Low/High:</strong> ' + todayLowF + '<span class="temp-unit">¬∞F</span> / ' + todayHighF + '<span class="temp-unit">¬∞F</span></div>' +
                    '<div class="detail-right"><strong>Humidity/Wind:</strong> ' + humidity + '% / ' + windSpeed + ' mph</div>' +
                    '</div>';

                html += '<div class="forecast-days">';

                for (var i = 1; i <= 3; i++) {
                    var dayName = getDayName(data.daily.time[i]);
                    var highC = Math.round(data.daily.temperature_2m_max[i]);
                    var highF = Math.round(highC * 9/5 + 32);
                    var lowC = Math.round(data.daily.temperature_2m_min[i]);
                    var lowF = Math.round(lowC * 9/5 + 32);
                    var dayIcon = getWeatherIcon(data.daily.weather_code[i]);
                    var dayRain = data.daily.precipitation_probability_max[i] || 0;

                    html += '<div class="forecast-day">' +
                        '<div class="forecast-day-name">' + dayName + '</div>' +
                        '<div class="forecast-day-inner">' +
                        '<div class="forecast-icon-col">' +
                        '<div class="forecast-icon">' + dayIcon + '</div>' +
                        '</div>' +
                        '<div class="forecast-info-col">' +
                        '<div class="forecast-temps">' +
                        '<div class="forecast-high">' + highF + '<span class="temp-unit">¬∞F</span></div>' +
                        '<div class="forecast-low">' + lowF + '<span class="temp-unit">¬∞F</span></div>' +
                        '</div>' +
                        '<div class="forecast-rain">üíß ' + dayRain + '%</div>' +
                        '</div>' +
                        '</div>' +
                        '</div>';
                }

                html += '</div>';

                if (el) el.innerHTML = html;

            } catch (e) {
                if (el) el.innerHTML = '<div class="debug-url-display">URL: ' + url + '</div>' + '<div class="error">Parse error: ' + e.message + '</div>';
            }
        } else {
            if (el) el.innerHTML = '<div class="debug-url-display">URL: ' + url + '</div>' + '<div class="error">HTTP Error ' + xhr.status + '</div>';
        }
    };

    xhr.onerror = function() {
        clearTimeout(timeoutId);
        var el = document.getElementById(elementId);
        if (el) el.innerHTML = '<div class="debug-url-display">URL: ' + url + '</div>' + '<div class="error">Network error</div>';
        console.error('XHR network error for', url);
    };

    xhr.ontimeout = function() { clearTimeout(timeoutId); var el = document.getElementById(elementId); if (el) el.innerHTML = '<div class="debug-url-display">URL: ' + url + '</div>' + '<div class="error">Request timeout</div>'; };

    xhr.send();
}

function fetchAllWeather() {
    fetchWeatherForLocation('weather-amsterdam', 52.3676, 4.9041);
    fetchWeatherForLocation('weather-maspalomas', 27.7609, -15.5863);
}

function isInActiveWindow() {
    var now = new Date();
    var utcDay = now.getUTCDay();
    var utcHour = now.getUTCHours();

    if (utcHour >= 0 && utcHour <= 7) return false;
    if (utcDay === 5 && utcHour >= 21) return false;
    if (utcDay === 6) return false;
    if (utcDay === 0 && utcHour < 21) return false;

    return true;
}

function fetchCurrency() {
    var lowThreshold = parseFloat(getUrlParameter('low')) || 1.1;
    var highThreshold = parseFloat(getUrlParameter('high')) || 1.2;

    var oxrRate = null, oxrDateTime = null;
    var ecbRate = null, ecbDate = null;
    var altRate = null, altDateTime = null;
    var completed = 0;

    function checkComplete() {
        completed++;
        if (completed >= 3) {
            displayCurrency();
        }
    }

    function displayCurrency() {
        var displayRate = oxrRate || ecbRate || altRate || '0.00000';
        var source = '';
        if (oxrRate) source = 'OXR';
        else if (ecbRate) source = 'ECB';
        else if (altRate) source = 'Alt';

        var rateNum = parseFloat(displayRate);
        var leftIcon = '';
        var rightIcon = '';
        if (rateNum < lowThreshold) leftIcon = '‚úÖ ';
        else if (rateNum > highThreshold) rightIcon = ' ‚ùå';

        var parts = [];
        if (oxrRate) parts.push('OXR $' + oxrRate + ' (' + oxrDateTime + ')');
        if (ecbRate) parts.push('ECB $' + ecbRate + ' (' + ecbDate + ')');
        if (altRate) parts.push('Alt $' + altRate + (altDateTime ? ' (' + altDateTime + ')' : ''));
        var infoLine = parts.join(' ‚Ä¢ ');

        var el = document.getElementById('currency-content');
        if (el) el.innerHTML = '<div class="card-title">' + leftIcon + 'EUR ‚Üí USD - $' + displayRate + (source ? ' (' + source + ')' : '') + rightIcon + '</div><div style="font-size: 0.7em; opacity: 0.7; margin-top: 4px; word-wrap: break-word; white-space: normal;">' + infoLine + '</div>';
    }

    var xhr1 = new XMLHttpRequest();
    var apiUrl1 = 'https://openexchangerates.org/api/latest.json?app_id=59f0442d524d41608055554519509c57';
    xhr1.open('GET', PROXY_URL + '?url=' + encodeURIComponent(apiUrl1), true);
    xhr1.onload = function() { if (xhr1.status === 200) { try { var data = JSON.parse(xhr1.responseText); var usdEurRate = data.rates.EUR; oxrRate = (1 / usdEurRate).toFixed(5); var updateDate = new Date(data.timestamp * 1000); var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; var month = months[updateDate.getMonth()]; var day = updateDate.getDate(); var hours = padZero(updateDate.getHours()); var minutes = padZero(updateDate.getMinutes()); oxrDateTime = month + ' ' + day + ', ' + hours + ':' + minutes;} catch (e) {} } checkComplete(); };
    xhr1.onerror = function() { checkComplete(); };
    xhr1.send();

    var xhr2 = new XMLHttpRequest();
    var apiUrl2 = 'https://api.frankfurter.app/latest?from=EUR&to=USD';
    xhr2.open('GET', PROXY_URL + '?url=' + encodeURIComponent(apiUrl2), true);
    xhr2.onload = function() { if (xhr2.status === 200) { try { var data = JSON.parse(xhr2.responseText); ecbRate = data.rates.USD.toFixed(5); ecbDate = data.date; } catch (e) {} } checkComplete(); };
    xhr2.onerror = function() { checkComplete(); };
    xhr2.send();

    var xhr3 = new XMLHttpRequest();
    var apiUrl3 = 'https://api.exchangerate-api.com/v4/latest/EUR';
    xhr3.open('GET', PROXY_URL + '?url=' + encodeURIComponent(apiUrl3), true);
    xhr3.onload = function() { if (xhr3.status === 200) { try { var data = JSON.parse(xhr3.responseText); altRate = data.rates.USD.toFixed(5); if (data.time_last_update_utc) { var updateDate = new Date(data.time_last_update_utc); if (!isNaN(updateDate.getTime())) { var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; var month = months[updateDate.getMonth()]; var day = updateDate.getDate(); var hours = padZero(updateDate.getHours()); var minutes = padZero(updateDate.getMinutes()); altDateTime = month + ' ' + day + ', ' + hours + ':' + minutes; } } } catch (e) {} } checkComplete(); };
    xhr3.onerror = function() { checkComplete(); };
    xhr3.send();

}

updateTime();
setInterval(updateTime, 1000);

fetchAllWeather();
fetchCurrency();

setInterval(fetchAllWeather, 600000);
setInterval(function() {
    if (isInActiveWindow()) {
        fetchCurrency();
    }
}, 3600000);
    </script>
  </template>

  <!-- ---- TPL: SE (index.html) ---- -->
  <template id="tpl-se">
    <style>
/* (index.html CSS copied verbatim) */
/* ... full SE CSS ... */
</style>

    <div class="container" id="container-se">
      <div>
        <div class="time" id="time-se">--:--</div>
        <div class="date" id="date-se">Loading...</div>
      </div>

      <div id="content-area-se" class="weather-row">
          <div class="card">
              <div class="card-title">Amsterdam</div>
              <div id="weather-amsterdam-se" class="loading">Loading...</div>
          </div>

          <div class="card">
              <div class="card-title">Maspalomas</div>
              <div id="weather-maspalomas-se" class="loading">Loading...</div>
          </div>

          <div class="card currency-card">
              <div id="currency-content-se" class="loading">Loading rate...</div>
          </div>
      </div>
    </div>

    <script type="text/template" data-script>
/* index.html script (small fix: check for element existence using getElementById) */
(function(){
    const urlParams = new URLSearchParams(window.location.search);
    const theme = urlParams.get('theme') || 'blue';
    document.body.classList.add(`theme-${theme}`);

    function padZero(num) { return num < 10 ? '0' + num : '' + num; }

    function updateTime() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const timeStr = `${hours}:${minutes}`;

        const dateStr = now.toLocaleDateString('en-US', {
            weekday: 'long',
            month: 'long',
            day: 'numeric'
        });

        var elTime = document.getElementById('time-se') || document.getElementById('time');
        var elDate = document.getElementById('date-se') || document.getElementById('date');
        if (elTime) elTime.textContent = timeStr;
        if (elDate) elDate.textContent = dateStr;
    }

    async function fetchWeatherForLocation(elementId, lat, lon) {
        try {
            const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m&daily=sunrise,sunset,temperature_2m_max,temperature_2m_min,precipitation_probability_max,weather_code&temperature_unit=celsius&wind_speed_unit=mph&timezone=auto&forecast_days=4`);
            const data = await response.json();

            const tempC = Math.round(data.current.temperature_2m);
            const tempF = Math.round(tempC * 9/5 + 32);
            const feelsLikeC = Math.round(data.current.apparent_temperature);
            const feelsLikeF = Math.round(feelsLikeC * 9/5 + 32);
            const humidity = data.current.relative_humidity_2m;
            const windSpeed = Math.round(data.current.wind_speed_10m);

            const highC = Math.round(data.daily.temperature_2m_max[0]);
            const highF = Math.round(highC * 9/5 + 32);
            const lowC = Math.round(data.daily.temperature_2m_min[0]);
            const lowF = Math.round(lowC * 9/5 + 32);

            const tomorrowHighC = Math.round(data.daily.temperature_2m_max[1]);
            const tomorrowHighF = Math.round(tomorrowHighC * 9/5 + 32);
            const tomorrowLowC = Math.round(data.daily.temperature_2m_min[1]);
            const tomorrowLowF = Math.round(tomorrowLowC * 9/5 + 32);

            const rainChance = data.daily.precipitation_probability_max[0] || 0;

            const sunrise = new Date(data.daily.sunrise[0]);
            const sunset = new Date(data.daily.sunset[0]);
            const riseTime = `${String(sunrise.getHours()).padStart(2, '0')}:${String(sunrise.getMinutes()).padStart(2, '0')}`;
            const setTime = `${String(sunset.getHours()).padStart(2, '0')}:${String(sunset.getMinutes()).padStart(2, '0')}`;

            const weatherCode = data.current.weather_code;
            let icon = '‚òÄÔ∏è';
            if (weatherCode === 0) { icon = '‚òÄÔ∏è'; }
            else if (weatherCode <= 3) { icon = '‚òÅÔ∏è'; }
            else if (weatherCode <= 67) { icon = 'üåßÔ∏è'; }
            else if (weatherCode <= 77) { icon = '‚ùÑÔ∏è'; }
            else if (weatherCode <= 99) { icon = '‚õàÔ∏è'; }

            const target = document.getElementById(elementId);
            if (!target) {
                console.warn('Target element not found for', elementId);
                return;
            }

            target.innerHTML = `
                <div class="weather-main">
                    <div>
                        <div class="temperature">${tempF}¬∞F<span style="font-size: 0.4em; opacity: 0.7; margin-left: 3px;">${tempC}¬∞C</span></div>
                        <div style="font-size: 0.65em; opacity: 0.8;">Feels: ${feelsLikeF}¬∞F</div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <div class="weather-icon">${icon}</div>
                        <div style="font-size: 0.55em; opacity: 0.8;">üíß${rainChance}%</div>
                    </div>
                </div>
                <div class="weather-details">
                    <div>Low/Tom:<br>${lowF}¬∞F / ${tomorrowLowF}¬∞F</div>
                    <div>High/Tom:<br>${highF}¬∞F / ${tomorrowHighF}¬∞F</div>
                    <div>Rise/Set:<br>${riseTime} / ${setTime}</div>
                    <div>Humidity/Wind:<br>${humidity}% / ${windSpeed} mph</div>
                </div>
            `;
        } catch (error) {
            var el = document.getElementById(elementId);
            if (el) el.innerHTML = '<div class="error">Weather unavailable</div>';
            console.error('fetchWeatherForLocation error for', elementId, error);
        }
    }

    function fetchAllWeather() {
        var idA = document.getElementById('weather-amsterdam-se') ? 'weather-amsterdam-se' : 'weather-amsterdam';
        var idM = document.getElementById('weather-maspalomas-se') ? 'weather-maspalomas-se' : 'weather-maspalomas';
        fetchWeatherForLocation(idA, 52.3676, 4.9041);
        fetchWeatherForLocation(idM, 27.7609, -15.5863);
    }

    function isInActiveWindow() {
        const now = new Date();
        const utcDay = now.getUTCDay();
        const utcHour = now.getUTCHours();

        if (utcHour >= 0 && utcHour <= 7) return false;
        if (utcDay === 5 && utcHour >= 21) return false;
        if (utcDay === 6) return false;
        if (utcDay === 0 && utcHour < 21) return false;

        return true;
    }

    async function fetchCurrency() {
        const params = new URLSearchParams(window.location.search);
        const lowThreshold = parseFloat(params.get('low')) || 1.1;
        const highThreshold = parseFloat(params.get('high')) || 1.2;

        let oxrRate = null, oxrDateTime = null;
        let ecbRate = null, ecbDate = null;
        let altRate = null, altDateTime = null;

        try {
            const response = await fetch('https://openexchangerates.org/api/latest.json?app_id=59f0442d524d41608055554519509c57');
            const data = await response.json();

            const usdEurRate = data.rates.EUR;
            oxrRate = (1 / usdEurRate).toFixed(5);

            const updateDate = new Date(data.timestamp * 1000);
            const month = updateDate.toLocaleString('en-US', { month: 'short' });
            const day = updateDate.getDate();
            const hours = String(updateDate.getHours()).padStart(2, '0');
            const minutes = String(updateDate.getMinutes()).padStart(2, '0');
            oxrDateTime = `${month} ${day}, ${hours}:${minutes}`;
        } catch (e) { console.warn('OXR fetch failed', e); }

        try {
            const resp = await fetch('https://api.frankfurter.app/latest?from=EUR&to=USD');
            const data = await resp.json();
            ecbRate = data.rates.USD.toFixed(5);
            ecbDate = data.date;
        } catch (e) { console.warn('ECB fetch failed', e); }

        try {
            const resp = await fetch('https://api.exchangerate-api.com/v4/latest/EUR');
            const data = await resp.json();
            altRate = data.rates.USD.toFixed(5);

            if (data.time_last_update_utc) {
                const updateDate = new Date(data.time_last_update_utc);
                if (!isNaN(updateDate.getTime())) {
                    const month = updateDate.toLocaleString('en-US', { month: 'short' });
                    const day = updateDate.getDate();
                    const hours = String(updateDate.getHours()).padStart(2, '0');
                    const minutes = String(updateDate.getMinutes()).padStart(2, '0');
                    altDateTime = `${month} ${day}, ${hours}:${minutes}`;
                }
            }
        } catch (e) { console.warn('Alt fetch failed', e); }

        const displayRate = oxrRate || ecbRate || altRate || '0.00000';
        const rateNum = parseFloat(displayRate);

        let leftIcon = '';
        let rightIcon = '';
        if (rateNum < lowThreshold) leftIcon = '‚úÖ ';
        else if (rateNum > highThreshold) rightIcon = ' ‚ùå';

        let infoLine = '';
        const parts = [];
        if (oxrRate) parts.push(`OXR $${oxrRate} (${oxrDateTime})`);
        if (ecbRate) parts.push(`ECB $${ecbRate} (${ecbDate})`);
        if (altRate) parts.push(`Alt $${altRate}${altDateTime ? ' (' + altDateTime + ')' : ''}`);
        infoLine = parts.join(' ‚Ä¢ ');

        var target = document.getElementById('currency-content-se') || document.getElementById('currency-content');
        if (target) {
            target.innerHTML = `
                <div class="card-title">${leftIcon}EUR ‚Üí USD - $${displayRate}${rightIcon}</div>
                <div style="font-size: 0.6em; opacity: 0.7; margin-top: 2px; word-wrap: break-word; white-space: normal;">${infoLine}</div>
            `;
        }
    }

    updateTime();
    setInterval(updateTime, 1000);

    fetchAllWeather();
    fetchCurrency();

    setInterval(fetchAllWeather, 600000);
    setInterval(() => {
        if (isInActiveWindow()) {
            fetchCurrency();
        }
    }, 3600000);
})();
    </script>
  </template>

  <script>
    (function(){
      var tplMap = { ipad2: document.getElementById('tpl-ipad2'), se: document.getElementById('tpl-se') };
      var LAYOUT_KEY = 'weather-dashboard-layout';
      var select = document.getElementById('layout-select');
      var urlParams = new URLSearchParams(window.location.search);
      var paramLayout = urlParams.get('layout');

      function supportsFetch(){ return 'fetch' in window; }
      function supportsSVG(){ try { return !!document.createElementNS && !!document.createElementNS('http://www.w3.org/2000/svg','svg').createSVGRect; } catch(e){ return false; } }
      function supportsGrid(){ return typeof CSS !== 'undefined' && CSS.supports && CSS.supports('display','grid'); }
      function isLegacyBrowser(){
        if (!supportsFetch()) return true;
        if (!supportsSVG()) return true;
        if (!supportsGrid() && !CSS.supports('display','flex')) return true;
        if (!('classList' in document.documentElement)) return true;
        return false;
      }

      function injectTemplate(name){
        var tpl = tplMap[name];
        var root = document.getElementById('root');

        // Remove previous injected nodes
        var prev = document.querySelectorAll('[data-injected-layout]');
        prev.forEach(function(n){ if (n && n.parentNode) n.parentNode.removeChild(n); });

        root.innerHTML = '';

        if (!tpl) {
          root.innerHTML = '<div style="padding:20px;">Requested layout not available: ' + name + '</div>';
          return;
        }

        // Inject style
        var styleEl = tpl.content.querySelector('style');
        if (styleEl) {
          var newStyle = document.createElement('style');
          newStyle.setAttribute('data-injected-layout','style-' + name);
          /* newStyle.className = 'injected-layout-style'; */
          newStyle.textContent = styleEl.textContent;
          document.head.appendChild(newStyle);
        }

        // Clone template content, remove script template nodes, append the rest
        var clone = tpl.content.cloneNode(true);
        var scripts = clone.querySelectorAll('script[type="text/template"][data-script]');
        scripts.forEach(function(s){ s.parentNode && s.parentNode.removeChild(s); });

        var nodes = Array.prototype.slice.call(clone.childNodes);
        nodes.forEach(function(n){
          if (n.nodeType === 1) n.setAttribute('data-injected-layout','node-' + name);
          root.appendChild(n);
        });

        // Execute script text from the original template
        var origScriptTpl = tpl.content.querySelector('script[type="text/template"][data-script]');
        if (origScriptTpl) {
          var code = origScriptTpl.textContent || origScriptTpl.innerText || '';
          try {
            var executable = document.createElement('script');
            executable.setAttribute('data-injected-layout','script-' + name);
            executable.text = code;
            document.body.appendChild(executable);
          } catch (e) {
            console.error('Failed to run injected layout script', e);
          }
        }
      }

      function setLayout(layout) {
        if (layout === 'auto') {
          layout = isLegacyBrowser() ? 'ipad2' : 'se';
        } else {
          // If the browser is legacy, force ipad2 even if user chose modern
          if (isLegacyBrowser() && layout !== 'ipad2') {
            console.warn('Legacy browser detected: forcing ipad2 layout (requested: ' + layout + ')');
            layout = 'ipad2';
          }
        }
        localStorage.setItem(LAYOUT_KEY, layout);
        select.value = layout;
        injectTemplate(layout);
      }

      var initial = paramLayout || localStorage.getItem(LAYOUT_KEY) || 'auto';
      if (initial === 'auto') initial = isLegacyBrowser() ? 'ipad2' : 'se';
      if (paramLayout) select.value = paramLayout;
      setLayout(initial);

      select.addEventListener('change', function(){
        var v = select.value;
        if (v === 'auto') {
          localStorage.removeItem(LAYOUT_KEY);
          setLayout('auto');
        } else {
          setLayout(v);
        }
      });

      window._wDashboard = { injectTemplate: injectTemplate, isLegacyBrowser: isLegacyBrowser };
    })();
  </script>
</body>
</html>
