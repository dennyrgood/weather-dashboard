<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weather Dashboard â€“ Streamlined</title>

  <style>
    html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;}
    #root{min-height:100vh;}
    #layout-switcher{
      position:fixed; right:12px; top:12px; z-index:99999;
      background:rgba(255,255,255,0.95); border:1px solid #ccc;
      padding:6px 8px; border-radius:6px; font-family:sans-serif; font-size:12px;
      box-shadow:0 2px 6px rgba(0,0,0,.12);
    }
    #layout-switcher label{margin-right:6px}
    #layout-switcher select{font-size:12px}
    #layout-hint{font-size:11px;opacity:.7;margin-top:6px}
  </style>

  <style id="shared-themes">
    body.theme-amber {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #1c1917;
    }
    body.theme-blue {
      background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%);
      color: #172554;
    }
    body.theme-green {
      background: linear-gradient(135deg, #dcfce7 0%, #86efac 100%);
      color: #064e3b;
    }
    body.theme-purple {
      background: linear-gradient(135deg, #ede9fe 0%, #a78bfa 100%);
      color: #4c1d95;
    }
  </style>

  <style id="layout-se">
    .layout-se #root {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0 16px;
      font-family: 'Inter', sans-serif;
    }
    .layout-se .weather-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(8px);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      padding: 24px;
      width: 100%;
      max-width: 320px;
      text-align: center;
      transition: transform 0.3s ease;
    }
    .layout-se .weather-card:hover {
      transform: translateY(-5px);
    }
    .layout-se .location-name {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .layout-se .date-time {
      font-size: 0.9rem;
      color: #6d6d6d;
      margin-bottom: 24px;
    }
    .layout-se .weather-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      animation: bounce 2s infinite;
    }
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
      40% {transform: translateY(-15px);}
      60% {transform: translateY(-8px);}
    }
    .layout-se .temperature {
      font-size: 4.5rem;
      font-weight: 300;
      line-height: 1;
      margin-bottom: 16px;
    }
    .layout-se .description {
      font-size: 1.25rem;
      font-weight: 500;
      text-transform: capitalize;
      margin-bottom: 24px;
    }
    .layout-se .details {
      display: flex;
      justify-content: space-around;
      padding-top: 16px;
      border-top: 1px solid #e5e5e5;
    }
    .layout-se .detail-item {
      font-size: 0.85rem;
    }
    .layout-se .detail-value {
      font-weight: 600;
      margin-top: 4px;
    }
    .layout-se .loading-indicator, .layout-se .status-message {
      padding: 20px;
      font-size: 1.1rem;
      color: #555;
    }
    .layout-se .loading-indicator {
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
  </style>

  <style id="layout-ipad2">
    .layout-ipad2 #root {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    .layout-ipad2 .header {
      width: 100%;
      max-width: 600px;
      padding: 10px 0;
      border-bottom: 2px solid #3b82f6;
      margin-bottom: 20px;
    }
    .layout-ipad2 .header h1 {
      margin: 0;
      font-size: 2rem;
      color: #172554;
      font-weight: 700;
    }
    .layout-ipad2 .location-name {
      font-size: 1.2rem;
      color: #1e40af;
      margin-bottom: 5px;
    }
    .layout-ipad2 .weather-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      width: 100%;
      max-width: 600px;
    }
    .layout-ipad2 .current-weather-card {
      grid-column: span 2;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 20px;
      display: flex;
      justify-content: space-around;
      align-items: center;
    }
    .layout-ipad2 .current-temp {
      font-size: 5rem;
      font-weight: 200;
      line-height: 1;
      color: #172554;
    }
    .layout-ipad2 .current-details {
      text-align: right;
    }
    .layout-ipad2 .current-details .description {
      font-size: 1.5rem;
      font-weight: 500;
      text-transform: capitalize;
    }
    .layout-ipad2 .detail-card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      padding: 15px;
      text-align: center;
      transition: all 0.2s;
    }
    .layout-ipad2 .detail-card:hover {
      background: #eff6ff;
    }
    .layout-ipad2 .detail-label {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .layout-ipad2 .detail-value {
      font-size: 1.5rem;
      font-weight: 600;
      margin-top: 5px;
      color: #172554;
    }
    .layout-ipad2 .loading-indicator, .layout-ipad2 .status-message {
      padding: 40px;
      font-size: 1.5rem;
      color: #555;
      text-align: center;
    }
  </style>
</head>
<body>

  <div id="root">
    <!-- Initial loading state, replaced by JS -->
    <div style="padding: 20px; text-align: center; font-family: sans-serif;">Loading dashboard...</div>
  </div>

  <div id="layout-switcher">
    <label for="layout-select">Layout:</label>
    <select id="layout-select">
      <option value="auto">Auto (iPad 2 / SE)</option>
      <option value="ipad2">iPad 2 (Los Angeles)</option>
      <option value="se">SE (Dhaka)</option>
    </select>
    <div id="layout-hint">Current: SE</div>
  </div>

  <script>
    // --- GLOBAL CONSTANTS ---
    const LAYOUT_KEY = 'weather-dashboard-layout';
    // Changed to Open-Meteo URL, as per your previous working code.
    const API_URL = 'https://api.open-meteo.com/v1/forecast';
    // Open-Meteo is keyless, so API_KEY is no longer needed.
    // const API_KEY = '5a6873550e56728e23f1165c711a19ce'; // Removed

    // --- UTILITY FUNCTIONS ---

    function getLayoutTemplate(layoutId, weatherHtml, locationName) {
      if (layoutId === 'se') {
        return `
          <div class="weather-card">
            <div class="location-name">${locationName}</div>
            ${weatherHtml}
          </div>
        `;
      } else if (layoutId === 'ipad2') {
        return `
          <div class="header">
            <h1>Weather Dashboard</h1>
            <div class="location-name">${locationName}</div>
          </div>
          <div class="weather-grid">
            ${weatherHtml}
          </div>
        `;
      }
      return '';
    }

    function injectTemplate(layoutId) {
      const root = document.getElementById('root');
      root.innerHTML = getLayoutTemplate(layoutId, '<div class="loading-indicator">Fetching weather data...</div>', 'Loading...');
      window._wDashboard.currentLayout = layoutId;
    }

    function isLegacyBrowser() {
      var ua = navigator.userAgent;
      // Simple check for iPad 2/3 and older Android that might struggle with modern JS
      return /iPad;.*OS [5-9]_\d/i.test(ua) || /Android [0-4]\.\d/i.test(ua);
    }

    // WMO Weather Code to Icon/Description Mapping (for Open-Meteo)
    function getWmoData(code) {
      const wmoMap = {
        0: { icon: 'â˜€ï¸', description: 'Clear sky' },
        1: { icon: 'ðŸŒ¤ï¸', description: 'Mostly clear' },
        2: { icon: 'â˜ï¸', description: 'Partly cloudy' },
        3: { icon: 'â˜ï¸', description: 'Overcast' },
        45: { icon: 'ðŸŒ«ï¸', description: 'Fog' },
        48: { icon: 'ðŸŒ«ï¸', description: 'Depositing rime fog' },
        51: { icon: 'ðŸŒ§ï¸', description: 'Light drizzle' },
        53: { icon: 'ðŸŒ§ï¸', description: 'Moderate drizzle' },
        55: { icon: 'ðŸŒ§ï¸', description: 'Dense drizzle' },
        61: { icon: 'ðŸŒ§ï¸', description: 'Slight rain' },
        63: { icon: 'ðŸŒ§ï¸', description: 'Moderate rain' },
        65: { icon: 'ðŸŒ§ï¸', description: 'Heavy rain' },
        71: { icon: 'â„ï¸', description: 'Slight snow fall' },
        73: { icon: 'â„ï¸', description: 'Moderate snow fall' },
        75: { icon: 'â„ï¸', description: 'Heavy snow fall' },
        80: { icon: 'ðŸŒ§ï¸', description: 'Slight rain showers' },
        81: { icon: 'ðŸŒ§ï¸', description: 'Moderate rain showers' },
        82: { icon: 'ðŸŒ§ï¸', description: 'Violent rain showers' },
        95: { icon: 'â›ˆï¸', description: 'Thunderstorm' },
        96: { icon: 'â›ˆï¸', description: 'Thunderstorm with slight hail' },
        99: { icon: 'â›ˆï¸', description: 'Thunderstorm with heavy hail' },
      };
      return wmoMap[code] || { icon: 'â“', description: 'Unknown' };
    }

    function formatTime(isoTime) {
      // Open-Meteo provides an ISO string (e.g., "2023-11-02T04:30")
      // Convert to Date object, treating the string as UTC to prevent local conversion issues, and format it simply.
      const date = new Date(isoTime);
      return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', day: 'numeric', month: 'short' });
    }

    // A fetch wrapper with simple exponential backoff retry logic
    function fetchWithRetry(url, attempts = 3) {
      return fetch(url).then(response => {
        if (!response.ok) {
          if (attempts > 1) {
            // Retry logic: wait and call again
            return new Promise(resolve => setTimeout(resolve, 1000)).then(() =>
              fetchWithRetry(url, attempts - 1)
            );
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response;
      });
    }

    function updateWeatherDisplay(data, locationName, message, isError = false) {
      const root = document.getElementById('root');
      if (!root) return;

      const layoutId = window._wDashboard.currentLayout;
      let weatherHtml = '';

      if (isError) {
        weatherHtml = `<div class="status-message">${message}</div>`;
      } else if (data) {
        // --- Open-Meteo Data Mapping ---
        const current = data.current;
        const daily = data.daily;
        const wmoData = getWmoData(current.weather_code);

        const temp = current.temperature_2m.toFixed(0);
        const description = wmoData.description;
        const icon = wmoData.icon;
        const humidity = current.relative_humidity_2m;
        const windSpeed = current.wind_speed_10m.toFixed(1); // Already in km/h from the request
        
        // Pressure is not provided in the simplified Open-Meteo request, using a dash.
        const pressure = '-'; 
        
        const time = formatTime(current.time);

        if (layoutId === 'se') {
          weatherHtml = `
            <div class="date-time">${time}</div>
            <div class="weather-icon">${icon}</div>
            <div class="temperature">${temp}Â°C</div>
            <div class="description">${description}</div>
            <div class="details">
              <div class="detail-item">Humidity<div class="detail-value">${humidity}%</div></div>
              <div class="detail-item">Wind<div class="detail-value">${windSpeed} km/h</div></div>
              <div class="detail-item">Pressure<div class="detail-value">${pressure} hPa</div></div>
            </div>
          `;
        } else if (layoutId === 'ipad2') {
          // Min/Max are from daily data, which is an array, take the first element (index 0)
          const tempMin = daily.temperature_2m_min[0].toFixed(0);
          const tempMax = daily.temperature_2m_max[0].toFixed(0);

          weatherHtml = `
            <div class="current-weather-card">
              <div class="current-temp">${temp}Â°C</div>
              <div class="current-details">
                <div class="description">${description}</div>
                <div style="font-size:3rem; margin-top:10px">${icon}</div>
                <div style="font-size:0.9rem; margin-top:5px; color:#6b7280;">${time}</div>
              </div>
            </div>
            <div class="detail-card">
              <div class="detail-label">Humidity</div>
              <div class="detail-value">${humidity}%</div>
            </div>
            <div class="detail-card">
              <div class="detail-label">Wind Speed</div>
              <div class="detail-value">${windSpeed} km/h</div>
            </div>
            <div class="detail-card">
              <div class="detail-label">Pressure</div>
              <div class="detail-value">${pressure} hPa</div>
            </div>
            <div class="detail-card">
              <div class="detail-label">Min/Max Temp</div>
              <div class="detail-value">${tempMin}Â°/${tempMax}Â°</div>
            </div>
          `;
        }
      }

      root.innerHTML = getLayoutTemplate(layoutId, weatherHtml, locationName);
      
      // Update hint text after content is loaded
      const hint = document.getElementById('layout-hint');
      if (hint) {
          const select = document.getElementById('layout-select');
          if (select && select.value !== 'auto') {
              hint.textContent = `Current: ${select.options[select.selectedIndex].text.split('(')[0].trim()}`;
          } else {
              hint.textContent = `Current: Auto (${layoutId.toUpperCase()})`;
          }
      }
    }

    function fetchWeather(lat, lon, locationName) {
      updateWeatherDisplay(null, locationName, 'Fetching weather...', false); // Show loading state

      // Construct the Open-Meteo URL using the fields required by the display logic
      const url = `${API_URL}?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&daily=temperature_2m_max,temperature_2m_min&temperature_unit=celsius&wind_speed_unit=kmh&timezone=auto&forecast_days=1`;

      fetchWithRetry(url)
        .then(response => response.json())
        .then(data => {
          // Open-Meteo validation check
          if (data && !data.error && data.current) {
            updateWeatherDisplay(data, locationName, null, false);
          } else {
            // Handle API specific error messages
            console.error('API responded with error/missing data:', data);
            updateWeatherDisplay(null, locationName, 'Weather data error (Open-Meteo).', true);
          }
        })
        .catch(error => {
          console.error('Weather fetch error after retries:', error);
          // This is triggered by an HTTP error (404, 500, or network failure)
          updateWeatherDisplay(null, locationName, 'Weather unavailable', true);
        });
    }

    function setLayout(layoutId) {
      window._wDashboard.currentLayout = layoutId;
      if (layoutId === 'se') {
        document.body.className = 'layout-se theme-amber';
        injectTemplate('se');
        fetchWeather(23.7779, 90.3994, 'Dhaka, Bangladesh'); // Hardcoded coordinates for SE
      } else if (layoutId === 'ipad2') {
        document.body.className = 'layout-ipad2 theme-blue';
        injectTemplate('ipad2');
        fetchWeather(34.0522, -118.2437, 'Los Angeles, USA'); // Hardcoded coordinates for iPad2
      } else {
        // Handle auto layout on re-set
        const autoLayout = isLegacyBrowser() ? 'ipad2' : 'se';
        setLayout(autoLayout);
      }

      try {
        if (layoutId !== 'auto') {
          localStorage.setItem(LAYOUT_KEY, layoutId);
        }
      } catch (e) { console.warn('Could not save layout preference to localStorage', e); }
    }

    // --- INITIALIZATION ---
    window.onload = function () {
      try {
        var select = document.getElementById('layout-select');
        var urlParams = new URLSearchParams(window.location.search);
        var paramLayout = urlParams.get('layout');

        if (paramLayout) {
          try {
            var _ls = document.getElementById('layout-switcher');
            if (_ls && _ls.parentNode) _ls.parentNode.removeChild(_ls);
          } catch (e) {}
        }

        var initial = paramLayout || (function(){ try { return localStorage.getItem(LAYOUT_KEY); } catch (e) { return null; } })() || 'auto';
        if (initial === 'auto') initial = isLegacyBrowser() ? 'ipad2' : 'se';
        if (paramLayout && select) {
          try { select.value = paramLayout; } catch(e) {}
        }
        setLayout(initial);
      } catch (e) {
        try {
          var root = document.getElementById('root');
          if (root) root.innerHTML = '<div style="padding:16px;color:#900;background:#fffbe6;border:1px solid#f1c40f;">Initialization error. See console for details.</div>';
        } catch (er) {}
        console.error('Runner init error', e);
      }

      try {
        if (select && select.addEventListener) {
          select.addEventListener('change', function () {
            var v = select.value;
            if (v === 'auto') {
              try { localStorage.removeItem(LAYOUT_KEY); } catch (e) {}
              setLayout('auto');
            } else {
              setLayout(v);
            }
          }, false);
        }
      } catch (e) {}

      try {
        window._wDashboard = { injectTemplate: injectTemplate, isLegacyBrowser: isLegacyBrowser };
        // Ensure initial layout is set correctly again after full load/setup
        const currentLayout = window._wDashboard.currentLayout;
        if (currentLayout) {
            setLayout(currentLayout);
        }
      } catch (e) {}
    };
  </script>
</body>
</html>
